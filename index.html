<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>طلب الضيافة — Mishkat</title>

<!-- CSS مودرن بنفسجي بزوايا ناعمة -->
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --primary:#5b21b6; --accent:#7c3aed; --muted:#6b7280;
    --ok:#16a34a; --glass:rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Arial, sans-serif}
  body{margin:0;background:var(--bg);color:#0b1220;padding:22px}
  .container{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,0.06)}
  h1{margin:0 0 6px;font-size:22px;color:var(--primary);text-align:right}
  p.small{color:var(--muted);margin:8px 0 16px;text-align:right}
  /* menu grid */
  .menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px}
  .item{background:#fbfbff;border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:transform .12s,box-shadow .12s;border:2px solid transparent}
  .item img{width:68px;height:68px;object-fit:contain;display:block;margin:6px auto}
  .item strong{display:block;margin-top:6px;font-size:15px}
  .item small{display:block;color:var(--muted);font-size:12px;margin-top:4px}
  .item.active{background:linear-gradient(180deg,#f3e8ff,#fff);border-color:var(--accent);box-shadow:0 8px 18px rgba(124,58,237,0.12);transform:translateY(-4px)}
  /* modifiers */
  .modifiers{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;justify-content:flex-start}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer;color:var(--muted);font-size:14px}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  /* right column */
  label{font-weight:700}
  input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6;margin-top:8px}
  .btn{display:inline-block;padding:12px 16px;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer;margin-top:12px}
  .btn.secondary{background:#10b981;margin-left:8px}
  .qrbox{text-align:center;padding:14px;border-radius:10px;background:#fbfbff;margin-top:12px}
  .summary{margin-top:12px;background:#fbfbff;padding:12px;border-radius:10px;font-size:14px}
  footer.note{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:980px){.container{grid-template-columns:1fr} .qrbox{margin-top:14px}}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT: menu -->
  <section class="card">
    <h1>أهلاً في ركن الضيافة — Mishkat</h1>
    <p class="small">اضغط على أيقونة المشروب لاختياره — يمكنك اختيار أكثر من عنصر. تحت كل اسم ستجد تسمية بالإنجليزية.</p>

    <div class="menu" id="menu"></div>

    <div class="modifiers" style="margin-top:12px">
      <div class="chip" data-mod="بدون سكر">بدون سكر<br><small>No sugar</small></div>
      <div class="chip" data-mod="سكر قليل">سكر قليل<br><small>Less sugar</small></div>
      <div class="chip" data-mod="سكر وسط">سكر وسط<br><small>Medium sugar</small></div>
      <div class="chip" data-mod="سكر زائد">سكر زائد<br><small>Extra sugar</small></div>
      <div class="chip" data-mod="بارد">بارد<br><small>Cold</small></div>
      <div class="chip" data-mod="ساخن">ساخن<br><small>Hot</small></div>
    </div>

    <div class="summary" id="summary" style="display:none"></div>
  </section>

  <!-- RIGHT: controls -->
  <aside class="card">
    <label>اسم الضيف / Guest name</label>
    <input id="guestName" type="text" placeholder="مثال: مدير المدرسة — Example: Principal" />

    <label style="margin-top:10px">ملاحظات (اختياري) / Notes (optional)</label>
    <input id="notes" type="text" placeholder="مثال: فنجان صغير — Example: small cup" />

    <div style="margin-top:12px">
      <button class="btn" id="sendBtn">إرسال الطلب الآن — Send Order</button>
      <button class="btn secondary" id="clearBtn">مسح الاختيارات — Clear</button>
    </div>

    <div class="qrbox">
      <div id="qrcodeCanvas"></div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">امسح QR لفتح نموذج الطلب من الهاتف — Scan to open order page</div>
    </div>

    <div style="margin-top:12px;text-align:center">
      <small class="note" style="color:var(--muted)">شغّل عبر Live Server إن ظهرت مشاكل في الصوت أو Firebase.</small>
    </div>
  </aside>
</div>

<!-- أصوات -->
<audio id="sendSound">
  <source src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3" type="audio/mpeg">
</audio>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* ===== Firebase v8 config (أدخل الإعدادات الخاصة بك إذا تغيّرت) ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBA8y6Z3CzA0v3UkLG03eOowcCBSwVm4Hk",
  authDomain: "mishkat-coffee.firebaseapp.com",
  databaseURL: "https://mishkat-coffee-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mishkat-coffee",
  storageBucket: "mishkat-coffee.firebasestorage.app",
  messagingSenderId: "1044002917128",
  appId: "1:1044002917128:web:947c927e9ff26538e17abd"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();
/* ================================================================== */

/* مشروبات + أيقونات (عربي + إنجليزي في small) */
const drinks = [
  { id:'قهوة_عربية', name:'قهوة عربية', en:'Arabic Coffee', icon:'https://img.icons8.com/color/96/turkish-coffee-pot.png' },
  { id:'شاي_كرك', name:'شاي كرك', en:'Karak Tea', icon:'https://img.icons8.com/color/96/tea.png' },
  { id:'نسكافيه', name:'نسكافيه', en:'Nescafe', icon:'https://img.icons8.com/color/96/coffee.png' },
  { id:'قهوة_لاتيه', name:'لاتيه', en:'Latte', icon:'https://img.icons8.com/color/96/latte.png' },
  { id:'كابتشينو', name:'كابتشينو', en:'Cappuccino', icon:'https://img.icons8.com/color/96/cappuccino.png' },
  { id:'هوت_شوكلت', name:'هوت شوكلت', en:'Hot Chocolate', icon:'https://img.icons8.com/color/96/hot-chocolate.png' },
  { id:'ماء', name:'ماء', en:'Water', icon:'https://img.icons8.com/color/96/water.png' },
  { id:'تمر', name:'تمر', en:'Dates', icon:'https://img.icons8.com/color/96/dates.png' },
  { id:'عصير', name:'عصير', en:'Juice', icon:'https://img.icons8.com/color/96/fruit-juice.png' },
  { id:'بيبسي', name:'بيبسي/مشروب غازي', en:'Soda', icon:'https://img.icons8.com/color/96/soda-can.png' },
  { id:'شاي_بارد', name:'شاي بارد', en:'Iced Tea', icon:'https://img.icons8.com/color/96/iced-tea.png' },
  { id:'شاي_اخضر', name:'شاي أخضر', en:'Green Tea', icon:'https://img.icons8.com/color/96/green-tea.png' }
];

/* عناصر الواجهة */
const menuEl = document.getElementById('menu');
const summaryEl = document.getElementById('summary');
const selected = new Map();
const prefs = new Set();

/* render items */
drinks.forEach(d=>{
  const div = document.createElement('div');
  div.className = 'item';
  div.dataset.id = d.id;
  div.innerHTML = `<img src="${d.icon}" alt="${d.name}"><strong>${d.name}</strong><small>${d.en}</small>`;
  div.addEventListener('click', ()=>{
    if(selected.has(d.id)) selected.delete(d.id);
    else selected.set(d.id, { id:d.id, name:d.name });
    div.classList.toggle('active');
    renderSummary();
  });
  menuEl.appendChild(div);
});

/* modifiers chips */
document.querySelectorAll('.chip').forEach(c=>{
  c.addEventListener('click', ()=>{
    const mod = c.dataset.mod;
    if(c.classList.contains('active')) { c.classList.remove('active'); prefs.delete(mod); }
    else { c.classList.add('active'); prefs.add(mod); }
    renderSummary();
  });
});

function renderSummary(){
  if(selected.size === 0 && prefs.size === 0){
    summaryEl.style.display = 'none'; return;
  }
  let html = '<strong>ملخص الطلب / Order summary:</strong><div style="margin-top:8px;text-align:right">';
  if(selected.size>0) html += '<div><b>مشروبات</b> / Drinks: ' + Array.from(selected.values()).map(s=>s.name).join(' ، ') + '</div>';
  if(prefs.size>0) html += '<div><b>تفضيلات</b> / Prefs: ' + Array.from(prefs).join(' ، ') + '</div>';
  summaryEl.innerHTML = html + '</div>';
  summaryEl.style.display = 'block';
}

/* QR Code */
const qr = new QRious({ element: document.createElement('canvas'), size: 170 });
qr.value = window.location.href;
document.getElementById('qrcodeCanvas').appendChild(qr.element);

/* Generate order number: 4-digit incremental using Firebase counter */
function generateOrderNumber(callback){
  // try to use a counter in DB (transaction)
  const counterRef = db.ref('meta/orderCounter');
  counterRef.transaction(current=>{
    return (current || 0) + 1;
  }, function(err, committed, snapshot){
    if(err || !committed){
      // fallback to random 4-digit
      const rnd = Math.floor(1000 + Math.random()*9000);
      callback(rnd);
    } else {
      callback(snapshot.val());
    }
  });
}

/* send order */
document.getElementById('sendBtn').addEventListener('click', ()=> {
  const name = document.getElementById('guestName').value.trim();
  const notes = document.getElementById('notes').value.trim();
  if(!name){ alert('الرجاء كتابة اسم الضيف — Please enter your name.'); return; }
  if(selected.size === 0){ alert('الرجاء اختيار مشروب واحد على الأقل — Choose at least one drink.'); return; }

  // build order
  const items = Array.from(selected.values()).map(s=>({ id:s.id, name:s.name }));
  const preferences = Array.from(prefs);

  // generate number then push
  generateOrderNumber(orderNum=>{
    const order = {
      orderNum: orderNum,
      name: name,
      items: items,
      prefs: preferences,
      notes: notes,
      time: new Date().toLocaleString()
    };
    db.ref('orders').push(order, err=>{
      if(err){ alert('حدث خطأ. حاول مرة أخرى.'); console.error(err); }
      else {
        // play sound (user initiated click => should play)
        const snd = document.getElementById('sendSound');
        snd.currentTime = 0;
        snd.play().catch(()=>{ /* ignored if blocked */ });

        alert('تم إرسال الطلب بنجاح ✔\\nرقم الطلب / Order number: ' + orderNum);
        // reset UI
        selected.clear(); prefs.clear();
        document.querySelectorAll('.item').forEach(el=>el.classList.remove('active'));
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        document.getElementById('guestName').value = '';
        document.getElementById('notes').value = '';
        renderSummary();
      }
    });
  });
});

/* clear button */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  selected.clear(); prefs.clear();
  document.querySelectorAll('.item').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  renderSummary();
});
</script>
</body>
</html>
